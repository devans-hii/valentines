<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Valentine Lock & Key</title>
  <style>
    :root{
      --bg:#111;
      --accent:#ff5d8f;
      --gold:#ffd26b;
      --lock:#222;
      --glow: rgba(255, 93, 143, 0.85);
    }
    html,body{height:100%;}
    body{
      margin:0;
      background: radial-gradient(ellipse at 10% 10%, #250a20 0%, #0b0210 40%, #050006 100%);
      color:#fff;
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:100vh;
      overflow:hidden;
    }

    .stage{
      width:760px;
      max-width:94vw;
      height:600px;
      max-height:86vh;
      position:relative;
      user-select:none;
      touch-action:none;
    }

    .shrine{
      width:360px;
      height:360px;
      margin:0 auto;
      position:relative;
      top:20px;
    }

    .heart-wrap{
      width:100%;
      height:100%;
      position:relative;
      display:block;
    }

    .heart-content{
      position:absolute;
      left:50%;
      top:50%;
      transform:translate(-50%,-50%) scale(0.9);
      width:84%;
      height:64%;
      border-radius:18px;
      overflow:hidden;
      box-shadow: 0 6px 30px rgba(0,0,0,0.6);
      opacity:0;
      transition: opacity 600ms ease 250ms, transform 700ms cubic-bezier(.2,.9,.2,1);
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      background:linear-gradient(180deg,rgba(255,255,255,0.04),rgba(0,0,0,0.06));
      color:#111;
    }
    .heart-content img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .message{
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      bottom:18%;
      font-size:28px;
      letter-spacing:1px;
      color: #fff;
      text-shadow:0 6px 18px rgba(0,0,0,0.6);
      opacity:0;
      transition:opacity 700ms ease 400ms, transform 700ms ease 400ms;
    }

    svg.heart-svg{width:100%;height:100%; display:block;}
    .heart-half{
      transform-origin:50% 50%;
      transition: transform 900ms cubic-bezier(.2,.9,.2,1), filter 300ms;
      filter: drop-shadow(0 6px 20px rgba(0,0,0,0.6));
    }

    .heart-left { transform-origin: 65% 30%; }
    .heart-right { transform-origin: 35% 30%; }

    .heart-open .heart-left { transform: rotate(-25deg) translate(-6px,-8px); }
    .heart-open .heart-right { transform: rotate(25deg) translate(6px,-8px); }
    .heart-open .heart-content { opacity:1; transform:translate(-50%,-50%) scale(1); }
    .heart-open .message { opacity:1; transform:translateX(-50%) translateY(0); }

    .lock {
      position:absolute;
      width:92px;
      height:92px;
      left:50%;
      top:34%;
      transform:translateX(-50%);
      z-index:40;
      pointer-events:none;
    }

    .lock .body { transition: fill 220ms ease, filter 220ms ease; }
    .lock.near .body { filter: drop-shadow(0 0 18px var(--glow)); }
    .lock.near .shackle { filter:drop-shadow(0 0 18px var(--glow)); }

    .lock.open .body { fill:#2f2f2f; }
    .lock .shackle {
      transform-origin: 50% 75%;
      transition: transform 700ms cubic-bezier(.2,.9,.2,1);
    }
    .lock.open .shackle { transform: rotate(-45deg) translateY(-6px) translateX(-2px); }

    /* Key uses left/top positioning (robust) */
    .key {
      width:160px;
      height:120px;
      position:absolute;
      left:0;
      top:0;
      z-index:80;
      touch-action:none;
      cursor:grab;
      transform-origin: 40px 36px; /* default rotation origin (will be updated in JS) */
    }
    .key.dragging{ cursor:grabbing; }

    .key svg{ width:100%; height:100%; display:block; pointer-events:none; }

    .key.inserted{
      transition: transform 600ms cubic-bezier(.2,.9,.2,1);
      z-index:90;
      pointer-events:none;
    }
    .key.turning { transition: transform 900ms cubic-bezier(.2,.9,.2,1); }

    .hint{
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      bottom:6px;
      color:rgba(255,255,255,0.65);
      font-size:13px;
      letter-spacing:0.6px;
    }

    .sparkle{
      position:absolute;
      left:50%;
      top:22%;
      width:20px;
      height:20px;
      margin-left:-10px;
      opacity:0;
      transform:translateY(-10px) scale(0.8);
      transition:opacity 220ms, transform 300ms;
      z-index:60;
      pointer-events:none;
    }
    .lock.near ~ .sparkle{ opacity:1; transform:translateY(0) scale(1); filter:drop-shadow(0 0 10px var(--glow)); }

    @media (max-width:520px){
      .stage{height:86vh;}
      .shrine{width:300px;height:300px;}
      .key{width:140px;height:100px;}
    }
  </style>
</head>
<body>
  <div class="stage" id="stage">
    <div class="shrine">
      <div class="heart-wrap" id="heartWrap" aria-hidden="false">
        <svg class="heart-svg" viewBox="0 0 200 200" preserveAspectRatio="xMidYMid meet" aria-hidden="true">
          <defs>
            <linearGradient id="g1" x1="0" x2="1" y1="0" y2="1">
              <stop offset="0" stop-color="#ff9bb7"/>
              <stop offset="1" stop-color="#ff5d8f"/>
            </linearGradient>
          </defs>

          <g class="heart-half heart-left" id="heartLeft">
            <path d="M100 34 C80 10, 32 14, 30 58 C28 100, 85 135, 100 153 Z"
                  fill="url(#g1)" stroke="rgba(0,0,0,0.08)" stroke-width="1.2" />
          </g>

          <g class="heart-half heart-right" id="heartRight">
            <path d="M100 34 C120 10, 168 14, 170 58 C172 100, 115 135, 100 153 Z"
                  fill="url(#g1)" stroke="rgba(0,0,0,0.08)" stroke-width="1.2" />
          </g>

        </svg>

        <div class="lock" id="lock" role="img" aria-label="locked heart">
          <svg viewBox="0 0 120 120" width="100%" height="100%" aria-hidden="true">
            <g class="shackle" id="shackle">
              <path d="M30 50 C30 26, 50 10, 60 10 C70 10, 90 26, 90 50 L90 60 L84 60 L84 50 C84 34, 70 22, 60 22 C50 22, 36 34, 36 50 L36 60 L30 60 Z"
                    fill="#dcdcdc" stroke="#c7c7c7" stroke-width="1"/>
            </g>

            <g transform="translate(12,48)">
              <rect class="body" id="lockBody" x="0" y="8" width="96" height="64" rx="10" ry="10" fill="#1f1f1f" stroke="#2b2b2b" />
              <rect x="40" y="28" width="16" height="10" rx="2" fill="#111" />
            </g>
          </svg>
        </div>

        <div class="heart-content" id="heartContent" role="region" aria-hidden="true">
          <img src="https://picsum.photos/520/360?blur=1" alt="valentine image" id="revealImage">
        </div>

        <div class="message" id="message">will u be my valentine</div>
      </div>
    </div>

    <div class="sparkle" id="sparkle" aria-hidden="true">
      <svg viewBox="0 0 24 24" width="100%" height="100%">
        <path d="M12 2 L13.5 9 L21 12 L13.5 15 L12 22 L10.5 15 L3 12 L10.5 9 Z" fill="#ffe7f0" opacity="0.95"/>
      </svg>
    </div>

    <div class="key" id="key" role="button" aria-label="drag key to unlock" tabindex="0" >
      <svg viewBox="0 0 240 180" preserveAspectRatio="xMinYMin meet" aria-hidden="true">
        <g id="keyHead">
          <circle cx="56" cy="56" r="28" fill="#ffd76b" stroke="#b8862b" stroke-width="3" />
          <circle cx="56" cy="56" r="12" fill="#fff7ea" />
        </g>
        <rect x="80" y="48" width="100" height="16" rx="6" fill="#ffd76b" stroke="#b8862b" stroke-width="3"/>
        <rect x="176" y="46" width="12" height="8" fill="#b8862b"/>
        <rect x="176" y="60" width="12" height="8" fill="#b8862b"/>
      </svg>
    </div>

    <div class="hint">Drag the key to the lock</div>

    <audio id="english"src="english.mp3" preload="auto"></audio>
  </div>

  <script>
    (function(){
      const stage = document.getElementById('stage');
      const key = document.getElementById('key');
      const lock = document.getElementById('lock');
      const heartWrap = document.getElementById('heartWrap');
      const heartContent = document.getElementById('heartContent');
      const message = document.getElementById('message');
      const sparkle = document.getElementById('sparkle');
      const audio = document.getElementById('song');

      let dragging = false;
      let opened = false;
      let offset = {x:0,y:0};
      let near = false;
      const nearThreshold = 72;
      const insertThreshold = 52;

      // place key using left/top (stage-local coordinates) without animating into place
      function resetKey(){
        const rect = stage.getBoundingClientRect();
        const krect = key.getBoundingClientRect();
        const left = Math.round((rect.width - krect.width)/2);
        const top = Math.round(rect.height - krect.height - 26);

        // disable transition so it doesn't animate to initial pos
        key.style.transition = 'none';
        key.style.left = left + 'px';
        key.style.top = top + 'px';
        key.style.transform = 'rotate(0deg)';
        // force reflow so the no-transition position takes effect immediately
        key.getBoundingClientRect();
        // re-enable transitions for later interactions
        requestAnimationFrame(()=> key.style.transition = '');
      }

      function toLocalPoint(clientX, clientY){
        const r = stage.getBoundingClientRect();
        return { x: clientX - r.left, y: clientY - r.top };
      }

      function getLockCenter(){
        const r = lock.getBoundingClientRect();
        const s = stage.getBoundingClientRect();
        return { x: r.left - s.left + r.width/2, y: r.top - s.top + r.height/2 };
      }

      function checkProximity(keyCenter){
        const lockCenter = getLockCenter();
        const dx = keyCenter.x - lockCenter.x;
        const dy = keyCenter.y - lockCenter.y;
        return Math.sqrt(dx*dx + dy*dy);
      }

      function setNearState(isNear){
        if(isNear && !near){
          lock.classList.add('near');
          near = true;
        }else if(!isNear && near){
          lock.classList.remove('near');
          near = false;
        }
      }

      function insertAndOpen(){
        if(opened) return;
        opened = true;
        lock.classList.remove('near');

        const lockRect = lock.getBoundingClientRect();
        const stageRect = stage.getBoundingClientRect();
        const keyRect = key.getBoundingClientRect();

        const slotStageX = lockRect.left - stageRect.left + lockRect.width*0.5;
        const slotStageY = lockRect.top - stageRect.top + lockRect.height*0.63;

        const headRelX = keyRect.width * 0.235;
        const headRelY = keyRect.height * 0.31;

        const targetLeft = Math.round(slotStageX - headRelX);
        const targetTop = Math.round(slotStageY - headRelY);

        key.classList.add('inserted');
        key.style.transition = 'left 420ms cubic-bezier(.2,.9,.2,1), top 420ms cubic-bezier(.2,.9,.2,1)';
        key.style.left = targetLeft + 'px';
        key.style.top = targetTop + 'px';

        key.addEventListener('transitionend', beginTurn, { once: true });

        function beginTurn(){
          const originX = headRelX;
          const originY = headRelY;
          key.style.transformOrigin = `${originX}px ${originY}px`;
          requestAnimationFrame(()=>{
            key.classList.add('turning');
            key.style.transform = 'rotate(-110deg)';
          });
          key.addEventListener('transitionend', finishOpen, { once: true });
        }

        function finishOpen(){
          lock.classList.add('open');
          heartWrap.classList.add('heart-open');
          heartContent.setAttribute('aria-hidden','false');
          const playPromise = audio.play();
          if(playPromise !== undefined){
            playPromise.then(()=>{}).catch(()=>{});
          }
        }
      }

      function onPointerDown(e){
        if(opened) return;
        dragging = true;
        key.classList.add('dragging');
        const local = toLocalPoint(e.clientX, e.clientY);

        const keyRect = key.getBoundingClientRect();
        const stageRect = stage.getBoundingClientRect();
        const keyLeft = keyRect.left - stageRect.left;
        const keyTop = keyRect.top - stageRect.top;
        offset.x = local.x - keyLeft;
        offset.y = local.y - keyTop;
        key.setPointerCapture && key.setPointerCapture(e.pointerId);
      }

      function onPointerMove(e){
        if(!dragging || opened) return;
        const local = toLocalPoint(e.clientX, e.clientY);
        const keyRect = key.getBoundingClientRect();
        const w = keyRect.width;
        const h = keyRect.height;
        let x = local.x - offset.x;
        let y = local.y - offset.y;
        x = Math.max(0, Math.min(stage.clientWidth - w, x));
        y = Math.max(0, Math.min(stage.clientHeight - h, y));
        key.style.left = x + 'px';
        key.style.top = y + 'px';

        const keyCenter = { x: x + w/2, y: y + h/2 };
        const dist = checkProximity(keyCenter);
        setNearState(dist < nearThreshold);

        if(near){
          const lockCenter = getLockCenter();
          sparkle.style.left = `${lockCenter.x}px`;
          sparkle.style.top = `${lockCenter.y - 60}px`;
        }
      }

      function onPointerUp(e){
        if(!dragging) return;
        dragging = false;
        key.classList.remove('dragging');
        try{ key.releasePointerCapture && key.releasePointerCapture(e.pointerId); }catch(err){}
        const keyRect = key.getBoundingClientRect();
        const stageRect = stage.getBoundingClientRect();
        const x = keyRect.left - stageRect.left;
        const y = keyRect.top - stageRect.top;
        const w = keyRect.width;
        const h = keyRect.height;
        const keyCenter = { x: x + w/2, y: y + h/2 };
        const dist = checkProximity(keyCenter);
        setNearState(false);
        if(dist < insertThreshold){
          insertAndOpen();
        }else{
          resetKey();
        }
      }

      key.addEventListener('pointerdown', onPointerDown);
      window.addEventListener('pointermove', onPointerMove);
      window.addEventListener('pointerup', onPointerUp);
      window.addEventListener('pointercancel', onPointerUp);

      function init(){
        resetKey();
        audio.load();
      }
      window.addEventListener('resize', resetKey);
      init();

      key.addEventListener('keydown', (ev)=>{
        if(opened) return;
        if(ev.key === 'Enter' || ev.key === ' '){
          ev.preventDefault();
          insertAndOpen();
        }
      });

    })();
  </script>
</body>
</html>
